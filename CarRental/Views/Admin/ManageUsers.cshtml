@model IEnumerable<CarRental.Models.User>

@{
    Layout = "_AdminDashboard";
    ViewData["Title"] = "Manage Users";
}

@section styles {
    <link rel="stylesheet" href="~/style/manageUsers.css">
}

<main class="dashboard-content">
    <header class="content-header">
        <h1>Manage Users</h1>
        <p>View all registered users, update their roles, or manage their account status</p>
    </header>

    <div class="manage-users-card">
        <div class="actions-bar">
            <div class="search-box">
                <input type="text" id="searchUsers" placeholder="Search users by name, email...">
            </div>
        </div>

        <table class="users-table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Registered</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Model)
                {
                    <tr>
                        <td class="user-cell">
                            <img src="@(user.ProfileImage ?? "/imgs/profile_img.svg")" alt="@user.FullName">
                            <span>@user.FullName</span>
                        </td>
                        <td>@user.Email</td>
                        <td>@user.Phone</td>
                        <td>
                            <select class="role-select" onchange="changeRole(@user.UserId, this.value)">

                                <option value="User" selected="@(user.Role == "User")">User</option>
                                <option value="Admin" selected="@(user.Role == "Admin")">Admin</option>n>
                            </select>
                        </td>
                        <td>
                            <span class="status-pill @(user.IsActive ? "active" : "inactive")">
                                @(user.IsActive ? "Active" : "Inactive")
                            </span>
                        </td>
                        <td>@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                        <td class="actions-cell">
                            <button onclick="toggleActive(@user.UserId)" title="@(user.IsActive ? "Deactivate" : "Activate")">
                                @(user.IsActive ? "❌" : "✔️")
                            </button>
                            <button onclick="deleteUser(@user.UserId)" title="Delete">
                                <img src="~/imgs/trash.svg" alt="Alternate Text" />
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</main>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Search functionality
$('#searchUsers').on('keyup', function() {
    const searchText = $(this).val().toLowerCase();
    $('tbody tr').each(function() {
        const userText = $(this).find('.user-cell span').text().toLowerCase() +
                         $(this).find('td:eq(1)').text().toLowerCase();
        $(this).toggle(userText.includes(searchText));
    });
});

// تغيير الدور
function changeRole(userId, role) {
    $.ajax({
        url: '@Url.Action("ChangeUserRole", "Admin")',
        type: 'POST',
        data: { userId: userId, role: role },
        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
        success: function(response) {
            if (!response.success) alert(response.message || 'Failed to update role');
        }
    });
}

// Toggle Active / Inactive
function toggleActive(userId) {
    $.ajax({
        url: '@Url.Action("ToggleUserStatus", "Admin")',
        type: 'POST',
        data: { userId: userId },
        headers: { 'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() },
        success: function(response) {
            if (response.success) location.reload();
            else alert(response.message || 'Failed to toggle status');
        }
    });
}

// Delete (Deactivate)
function deleteUser(userId) {
    if (confirm('Are you sure to deactivate this user?')) {
        toggleActive(userId); // يستخدم نفس التوجيل للتعطيل
    }
}

// Show Add Admin Modal
function showAddAdminModal() {
    $('#addAdminModal').fadeIn();
}

$('#addAdminForm').on('submit', function(e) {
    e.preventDefault();
    $.ajax({
        url: '@Url.Action("CreateAdmin", "Admin")',
        type: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            if (response.success) location.reload();
            else alert(response.message || 'Failed to create admin');
        }
    });
});

    </script>
}